<!DOCTYPE html>
<html xmlns:th="https://thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>Post</title>
	</head>
	<body>
		<div th:object="${post}">
			<p th:text="${post.postId}"></p>
			<h1 th:text="*{title}"></h1>
			<h3 th:text="*{content.text}"></h3>
			<img th:src="*{content.image}"/>
			<div th:if="*{content.audio != ''}">
				<audio controls>
					<source th:src="@{*{content.audio}}" type="audio/mpeg">
					<source th:src="@{*{content.audio}}" type="audio/ogg">
					<source th:src="@{*{content.audio}}" type="audio/wav">
					Your browser does not support the audio element.
				</audio>
			</div>
			<div th:if="${content.recording != ''}">
				<audio controls>
					<source th:src="@{*{content.recording}}" type="audio/ogg">
					<source th:src="@{*{content.recording}}" type="audio/wav">
					Your browser does not support the audio element.
				</audio>
			</div>
			<p th:text="${post.created}"></p>
		</div>
		<div th:replace="fragments/reply :: replies"></div>
		<!-- <div th:switch="${postReplies}">
			<ul th:case="*">
				<li th:each="postReply : ${postReplies}">
					<p th:text="${postReply.content.text}"></p>
					<img th:src="${postReply.content.image}"/>
					<div th:if="${postReply.content.audio != ''}">
						<audio controls>
							<source th:src="@{${postReply.content.audio}}" type="audio/mpeg">
							<source th:src="@{${postReply.content.audio}}" type="audio/ogg">
							<source th:src="@{${postReply.content.audio}}" type="audio/wav">
							Your browser does not support the audio element.
						</audio>
					</div>
					<div th:if="${postReply.content.recording != ''}">
						<audio controls>
							<source th:src="@{${postReply.content.recording}}" type="audio/ogg">
							<source th:src="@{${postReply.content.recording}}" type="audio/wav">
							Your browser does not support the audio element.
						</audio>
					</div>
					<div th:switch="${postReply.replies}">
						<ul th:case="*">
							<li th:each="reply : ${postReply.replies}">
								<p th:text="${reply.content.text}"></p>
								<img th:src="${reply.content.image}"/>
								<div th:if="${reply.content.audio != ''}">
									<audio controls>
										<source th:src="@{${reply.content.audio}}" type="audio/mpeg">
										<source th:src="@{${reply.content.audio}}" type="audio/ogg">
										<source th:src="@{${reply.content.audio}}" type="audio/wav">
										Your browser does not support the audio element.
									</audio>
								</div>
								<div th:if="${reply.content.recording != ''}">
									<audio controls>
										<source th:src="@{${reply.content.recording}}" type="audio/ogg">
										<source th:src="@{${reply.content.recording}}" type="audio/wav">
										Your browser does not support the audio element.
									</audio>
								</div>
							</li>
						</ul>
					</div>
					<form action="#" th:action="@{/post/} + ${post.postId} + @{/} + ${postReply.replyId}" method="post" enctype="multipart/form-data">
						<div>
							<input
								type="text"
								field="*{text}"
								name="text"
								id="replyText"
								placeholder="What's on your mind?">

							<label for="image">Image file</label>
							<input
									type="file"
									field="*{image}"
									name="image"
									id="replyImage"
									accept="image/*">

							<input
									type="text"
									field="*{recording}"
									value="recording"
									onchange="test(this)"
									name="recording"
									id="replyRecording"
									hidden>

							<label for="audio">Audio file</label>
							<input type="button" onclick="recordAudio(this, 'replyRecording')" value="Record">
							<input
									type="file"
									onchange="play(this)"
									value="*{audio}"
									name="audio"
									id="replyAudio"
									accept="audio/*"
									capture>
						</div>
						<input type="submit" value="Add comment">
					</form>
				</li>
			</ul>
		</div> </!-->
		<form enctype="multipart/form-data" action="#" th:action="@{/post/} + ${post.postId}" method="post">
			<div>
				<input
					type="text"
					field="*{text}"
					name="text"
					id="text"
					placeholder="What's on your mind?">
				
				<label for="image">Image file</label>
				<input
					type="file"
					field="*{image}"
					name="image"
					id="image"
					accept="image/*">
				
				<input
					type="text"
					field="*{recording}"
					value="recording"
					onchange="test(this)"
					name="recording"
					id="recording"
					hidden>

				<label for="audio">Audio file</label>
				<input type="button" onclick="recordAudio(this, 'recording')" value="Record">
				<script>
					let record = false;
					let mediaRecorder;
					let chunks = [];
					
					function recordAudio(el, reply) {
						if(!record) {
							navigator.mediaDevices.getUserMedia({audio: true, video: false})
								.then((stream) => {
									mediaRecorder = new MediaRecorder(stream);
									
									mediaRecorder.ondataavailable = (e) => {
										chunks.push(e.data);
									}
									
									mediaRecorder.onstop = async (e) => {
										let audioPlayer = document.getElementById('player');
										

										const blob = new Blob(chunks, {type: "audio/ogg"});
										var dataUrl = await new Promise(r => {
											let a = new FileReader();
											a.onload = r;
											a.readAsDataURL(blob)
										}).then(e => e.target.result);
										chunks = [];
										const audioUrl = window.URL.createObjectURL(blob);
										audioPlayer.src = audioUrl;
										let recording = document.getElementById(reply);
										recording.value = dataUrl;
										
									}
									
									mediaRecorder.start();
									record = !record;
									changeButtonValue(el);
								})
								.catch((err) => {
								console.log(err);
							});
						} else {
							mediaRecorder.stop();
							record = !record;
							changeButtonValue(el)
						}
					}
					
					function changeButtonValue(el) {
						if(el.getAttribute("value") === "Record") {
							el.setAttribute("value", "Stop");
						} else {
							el.setAttribute("value", "Record");
						}
					}
				</script>
				<input
					type="file"
					onchange="play(this)"
					value="*{audio}"
					name="audio"
					id="audio"
					accept="audio/*"
					capture>
				<script>
					function play(el) {
						let player = document.getElementById('player');

						if(!el.files.length) return;
						const audioUrl = URL.createObjectURL(el.files[0]);
						player.src = audioUrl;
					}
				</script>
				<audio id="player" controls></audio>
			</div>
			<input type="submit" value="Add comment">
		</form>
	</body>
</html>